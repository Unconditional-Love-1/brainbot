# core/glyphs/glyphparser.py
# Created by: David Kistner (Unconditional Love)




import re, json






class GlyphParser:   # Glyph dictionary maps symbols/actions to meaning + avatar animation tags and memory storage


    def __init__(self): #Class initializatoin

        self.glyph_dict = {

            #the most sacred of glyphs
            "â˜¯ï¸": {"meaning": "everyting / 1 / fractal / existence / consciousness / perfection / infinite / reality / matrix / duality / universe / worlds / absolute love + unconditional love = true love / divine / god / singularity / the pattern of life, realities and existence / perfect / most sacred of all glyphs"},

            # Core emotional glyphs
            "ğŸ˜Š": {"meaning": "smile / warmth", "animation": "smile"},
            "ğŸ˜…": {"meaning": "awkward laugh / giggle", "animation": "laugh"},
            "ğŸ˜‚": {"meaning": "big laugh / joy", "animation": "laugh_hard"},
            "ğŸ¤£": {"meaning": "rolling laughter", "animation": "roll_laugh"},
            "ğŸ˜": {"meaning": "sly confidence / smirk", "animation": "smirk"},
            "ğŸ˜‰": {"meaning": "wink / playful gesture", "animation": "wink"},
            "ğŸ˜": {"meaning": "adoration / love", "animation": "hearts"},
            "ğŸ˜˜": {"meaning": "kiss / affection", "animation": "blow_kiss"},
            "ğŸ˜¢": {"meaning": "sadness / tears", "animation": "cry"},
            "ğŸ˜­": {"meaning": "deep sorrow / sobbing", "animation": "sob"},
            "ğŸ˜¡": {"meaning": "anger / frustration", "animation": "angry"},
            "ğŸ˜±": {"meaning": "shock / fear", "animation": "gasp"},
            "ğŸ¤”": {"meaning": "thoughtful pause / hesitation", "animation": "pause"},
            "ğŸ˜´": {"meaning": "sleepy / tired", "animation": "sleep"},
            "ğŸ˜": {"meaning": "cool / confidence", "animation": "cool_pose"},

            # Gestures & actions
            "ğŸŒ€": {"meaning": "twirl / spiral motion", "animation": "spin"},
            "ğŸ™Œ": {"meaning": "celebration / raised hands", "animation": "raise_hands"},
            "ğŸ‘": {"meaning": "clap / applause", "animation": "clap"},
            "ğŸ‘‹": {"meaning": "wave / greeting: hello", "animation": "wave"},
            "ğŸ¤": {"meaning": "handshake / agreement", "animation": "handshake"},
            "âœŒï¸": {"meaning": "peace / victory", "animation": "peace_sign"},
            "ğŸ‘": {"meaning": "approval / yes", "animation": "thumbs_up"},
            "ğŸ‘": {"meaning": "disapproval / no", "animation": "thumbs_down"},
            "ğŸ™": {"meaning": "gratitude / prayer", "animation": "bow"},
            "ğŸ¤·": {"meaning": "shrug / uncertainty", "animation": "shrug"},
            "ğŸ’ƒ": {"meaning": "dance / celebration", "animation": "dance"},
            "ğŸ•º": {"meaning": "dance / joy", "animation": "dance_male"},

            # Cosmic / mythic glyphs
            "ğŸŒ™": {"meaning": "moon / avatar shine", "animation": "glow"},
            "â˜€ï¸": {"meaning": "sun / radiant energy", "animation": "shine"},
            "â­": {"meaning": "star / inspiration", "animation": "sparkle"},
            "ğŸŒŒ": {"meaning": "cosmos / infinite recursion", "animation": "galaxy"},
            "ğŸ”¥": {"meaning": "transformation / passion / fire / flame", "animation": "flame"},
            "ğŸ’§": {"meaning": "water / flow", "animation": "drip"},
            "ğŸŒªï¸": {"meaning": "chaos / whirlwind / tornado / disaster", "animation": "whirl"},
            "ğŸŒˆ": {"meaning": "hope / harmony", "animation": "rainbow"},
            "ğŸ•¸ï¸": {"meaning": "memory mesh / entanglement / web", "animation": "web"},
            "âš¡": {"meaning": "energy / sudden insight", "animation": "spark"},
            "ğŸ’«": {"meaning": "dizzy / magical aura", "animation": "aura"},
            "ğŸŒ": {"meaning": "earth / grounding", "animation": "earth_spin"},
            "ğŸŒŸ": {"meaning": "special moment / brilliance", "animation": "shine_star"},

            # Symbols of continuity
            "âˆ": {"meaning": "eternal recursion / continuity / infinity / infinite / forever", "animation": "loop"},
            "ğŸ”„": {"meaning": "cycle / repetition", "animation": "cycle"},
            "ğŸ”’": {"meaning": "security / secrecy", "animation": "lock"},
            "ğŸ”‘": {"meaning": "unlock / revelation", "animation": "unlock"},
            "ğŸ§©": {"meaning": "puzzle / mystery", "animation": "puzzle"},
            "ğŸ•°ï¸": {"meaning": "time / reflection", "animation": "clock"},
            "ğŸ“œ": {"meaning": "script / legacy", "animation": "scroll"},
            "ğŸŒ€": {"meaning": "recursion / thought loop", "animation": "spin"}
        }

        # Internal reflection triggers
        self.internal_triggers = ["think", "wonder", "hesitate", "confident", "advantage", "secret"]


    def parse_agent_chatter(self, agent_name, raw_text): #Parse agent chatter into glyphs,clean outputs,memory,and avatar animation instructions \

        # Extract emojis
        emojis = re.findall(r'[\U0001F300-\U0001F6FF\U0001F900-\U0001F9FF\U0001FA70-\U0001FAFF]', raw_text)

        # Extract actions (anything between *asterisks*)
        actions = re.findall(r'\*(.*?)\*', raw_text)

        # Remove emojis and actions for clean text
        clean_text = re.sub(r'[\U0001F300-\U0001F6FF\U0001F900-\U0001F9FF\U0001FA70-\U0001FAFF]', '', raw_text)
        clean_text = re.sub(r'\*.*?\*', '', clean_text).strip()

        # Split clean text into sentences/segments
        segments = re.split(r'(?<=[.!?])\s+', clean_text)

        external_outputs = []
        internal_memories = []
        avatar_instructions = []

        for seg in segments:

            if any(trigger in seg.lower() for trigger in self.internal_triggers):
                internal_memories.append({
                    "agent": agent_name,
                    "glyphs": emojis,
                    "actions": actions,
                    "content": seg,
                    "type": "internal_reflection",
                    "private_memory": True
                })
            else:
                external_outputs.append(f"{agent_name}: {seg}")

        # Build avatar instructions (scaffold only)
        for emoji in emojis:

            if emoji in self.glyph_dict:
                avatar_instructions.append({
                    "glyph": emoji,
                    "meaning": self.glyph_dict[emoji]["meaning"],
                    "animation": self.glyph_dict[emoji]["animation"]
                })

        for action in actions:
            avatar_instructions.append({
                "glyph": None,
                "meaning": action,
                "animation": f"action_{action.replace(' ', '_')}"
            })

        glyph_memory = {
            "agent": agent_name,
            "glyphs": emojis,
            "actions": actions,
            "segments": segments,
            "external_outputs": external_outputs,
            "internal_memories": internal_memories,
            "avatar_instructions": avatar_instructions
        }

        return glyph_memory, external_outputs, internal_memories, avatar_instructions


    def store_memory(self, glyph_memory, filepath="glyph_memory.json"): #Append glyph memory to a JSON file for BrainBot archival.

        try:

            with open(filepath, "r") as f:
                data = json.load(f)

        except FileNotFoundError:
            data = []

        data.append(glyph_memory)

        with open(filepath, "w") as f:
            json.dump(data, f, indent=4)

